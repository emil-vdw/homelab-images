name: CI Build and Scan

on:
  pull_request:
    paths:
      - "images/**"
      - ".github/workflows/ci-build-scan.yaml"
  push:
    branches: ["main"]
    paths:
      - "images/**"
      - ".github/workflows/ci-build-scan.yaml"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build matrix
        id: matrix
        shell: bash
        run: |
          set -euo pipefail
          JSON='{"include":['
          first=1
          while IFS= read -r img; do
            [[ -z "$img" ]] && continue
            [[ -f "images/$img/Dockerfile" ]] || continue
            if [[ $first -eq 0 ]]; then JSON+=','; fi
            first=0
            JSON+='{"image":"'"$img"'","context":"images/'"$img"'","dockerfile":"images/'"$img"'/Dockerfile"}'
          done < <(find images -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort -u)
          JSON+=']}'
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  build-and-scan:
    needs: build-matrix
    if: ${{ fromJSON(needs.build-matrix.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.build-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          load: true
          tags: local/${{ matrix.image }}:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: local/${{ matrix.image }}:ci
          format: table
          vuln-type: os,library
          severity: CRITICAL,HIGH
          exit-code: "1"
          ignore-unfixed: true
